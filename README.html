<!DOCTYPE html>
<!-- saved from url=(0084)file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>README</title>
      
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="./README_files/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="è¾“å…¥æ³•çš®è‚¤ç”Ÿæˆ">è¾“å…¥æ³•çš®è‚¤ç”Ÿæˆ </h1>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#1-%E9%98%B6%E6%AE%B51" class="md-toc-link"><ol>
<li>é˜¶æ®µ1</li>
</ol>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E6%96%B9%E6%A1%88%E7%A1%AE%E5%AE%9A" class="md-toc-link">
            <p>ğŸ˜€ æ–¹æ¡ˆç¡®å®š</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E6%96%B9%E6%A1%88%E9%AA%8C%E8%AF%81" class="md-toc-link"><p>ğŸ˜€ æ–¹æ¡ˆéªŒè¯</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87" class="md-toc-link">
            <p>âš™å‰æœŸå‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%95%B0%E6%8D%AE%E9%9B%86%E5%87%86%E5%A4%87" class="md-toc-link">
            <p>ğŸ“•æ•°æ®é›†å‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83" class="md-toc-link">
            <p>æ¨¡å‹è®­ç»ƒ</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#2-%E9%98%B6%E6%AE%B52" class="md-toc-link"><ol start="2">
<li>é˜¶æ®µ2</li>
</ol>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E5%AE%9E%E9%AA%8C%E4%B8%80%E5%85%A8%E9%94%AE%E7%9B%98%E7%9A%AE%E8%82%A4%E6%95%B0%E6%8D%AE%E8%AE%AD%E7%BB%83" class="md-toc-link"><p>ğŸ˜€ å®éªŒä¸€ï¼šå…¨é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%95%B0%E6%8D%AE%E9%9B%86%E5%87%86%E5%A4%87-1" class="md-toc-link">
            <p>ğŸ“•æ•°æ®é›†å‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83-1" class="md-toc-link">
            <p>æ¨¡å‹è®­ç»ƒ</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C" class="md-toc-link">
            <p>å®éªŒç»“æœ</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E5%AE%9E%E9%AA%8C%E4%BA%8C%E5%88%86%E5%9D%97%E9%94%AE%E7%9B%98%E7%9A%AE%E8%82%A4%E6%95%B0%E6%8D%AE%E8%AE%AD%E7%BB%83" class="md-toc-link"><p>ğŸ˜€ å®éªŒäºŒï¼šåˆ†å—é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%95%B0%E6%8D%AE%E9%9B%86%E5%87%86%E5%A4%87-2" class="md-toc-link">
            <p>ğŸ“•æ•°æ®é›†å‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83-2" class="md-toc-link">
            <p>æ¨¡å‹è®­ç»ƒ</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-1" class="md-toc-link">
            <p>å®éªŒç»“æœ</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#3-%E9%98%B6%E6%AE%B53" class="md-toc-link"><ol start="3">
<li>é˜¶æ®µ3</li>
</ol>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E5%AE%9E%E9%AA%8C%E4%B8%80%E5%85%B3%E9%94%AE%E9%94%AE%E7%9B%98%E5%85%83%E7%B4%A0%E5%B8%83%E5%B1%80%E7%9A%AE%E8%82%A4" class="md-toc-link"><p>ğŸ˜€ å®éªŒä¸€ï¼šå…³é”®é”®ç›˜å…ƒç´ å¸ƒå±€çš®è‚¤</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87" class="md-toc-link">
            <p>ğŸ“• æ•°æ®å‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83-3" class="md-toc-link">
            <p>æ¨¡å‹è®­ç»ƒ</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-2" class="md-toc-link">
            <p>å®éªŒç»“æœ</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E5%AE%9E%E9%AA%8C%E4%BA%8C%E6%B7%BB%E5%8A%A0ctc-loss%E7%9B%91%E7%9D%A3%E5%9B%BE%E7%89%87%E4%B8%AD%E7%9A%84%E6%96%87%E6%9C%AC%E7%94%9F%E6%88%90" class="md-toc-link"><p>ğŸ˜€ å®éªŒäºŒï¼šæ·»åŠ ctc-lossç›‘ç£å›¾ç‰‡ä¸­çš„æ–‡æœ¬ç”Ÿæˆ</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87-1" class="md-toc-link">
            <p>ğŸ“• æ•°æ®å‡†å¤‡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83-4" class="md-toc-link">
            <p>æ¨¡å‹è®­ç»ƒ</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-3" class="md-toc-link">
            <p>å®éªŒç»“æœ</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:18px">
          <a href="file:///C:/Users/kunhu10/AppData/Local/Temp/crossnote2024129-13228-1v7ifkj.he54.html#4-%E5%90%8E%E7%BB%AD" class="md-toc-link">
            <ol start="4">
<li>åç»­</li>
</ol>

          </a></div>
</div>
<h2 id="1-é˜¶æ®µ1">1. é˜¶æ®µ1 </h2>
<h3 id="-æ–¹æ¡ˆç¡®å®š">ğŸ˜€ æ–¹æ¡ˆç¡®å®š </h3>
<ul>
<li>
<p>ç¡®å®šæ–¹æ¡ˆä¸ºä½¿ç”¨ Controlnet æ§åˆ¶å›¾ç‰‡ç”Ÿæˆ</p>
</li>
<li>
<p>æ—¨åœ¨è¾¾åˆ°å›¾ä¸­æ•ˆæœï¼Œæ ¹æ®æ§åˆ¶å›¾ç‰‡çš„è§„èŒƒç”Ÿæˆå›¾ç‰‡çš„è½®å»“ï¼Œç»†èŠ‚äº¤ç”±æ¨¡å‹è‡ªå·±ç”Ÿæˆ</p>
</li>
</ul>
<img src="./README_files/fig1.jpg" width="500" height="500">
<h3 id="-æ–¹æ¡ˆéªŒè¯">ğŸ˜€ æ–¹æ¡ˆéªŒè¯ </h3>
<h4 id="å‰æœŸå‡†å¤‡">âš™å‰æœŸå‡†å¤‡ </h4>
<ul>
<li>ç¯å¢ƒé…ç½®</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>python <span class="token operator">=</span> <span class="token number">3.10</span>
torch <span class="token operator">=</span> <span class="token number">1.13</span>.1+cu117
pip <span class="token function">install</span> requirements.txt <span class="token parameter variable">-r</span>
</code></pre><p>or</p>
<p>copy kunhu10 condaåˆ›å»ºçš„ <code>diff</code> è™šæ‹Ÿç¯å¢ƒ</p>
<ul>
<li>
<p>diffusion åŸºç¡€æ¨¡å‹ä¸º stable-diffusion-xl-base-1.0<br>
å­˜å‚¨åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/base_models/stable-diffusion-xl-base-1.0</code></p>
</li>
<li>
<p>å›¾ç‰‡ caption æ¨¡å‹ Blip æ¨¡å‹å­˜å‚¨åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/base_models/blip-image-captioning-large</code></p>
</li>
</ul>
<h4 id="æ•°æ®é›†å‡†å¤‡">ğŸ“•æ•°æ®é›†å‡†å¤‡ </h4>
<ul>
<li>
<p>ä¸ºäº†ç¡®å®š <a href="https://github.com/huggingface/diffusers">diffusers</a> (<code>diffusers-main/examples/controlnet/train_controlnet_sdxl.py</code>) ä»£ç çš„å¯è¡Œæ€§ï¼Œä½¿ç”¨ <code>fill50k</code> æ•°æ®é›†è¿›è¡Œäº†éªŒè¯</p>
</li>
<li>
<p>è¯¥æ•°æ®é›†å…·æœ‰å¦‚ä¸‹æ ¼å¼ï¼Œç›®æ ‡å›¾ç‰‡ï¼Œæ§åˆ¶å›¾ç‰‡ï¼Œä»¥åŠæ–‡æœ¬æè¿°æ–‡ä»¶ <code>train.jsonl</code>ï¼Œå¦‚ä¸‹</p>
</li>
</ul>
<p><code>{"text": "pale golden rod circle with old lace background", "image": "images/0.png", "conditioning_image": "conditioning_images/0.png"}</code><br>
<img src="./README_files/images0.png" width="200" height="200">&nbsp;&nbsp;<img src="./README_files/conditioning_images0.png" width="200" height="200"></p>
<ul>
<li>ä¿å­˜åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/fill50k/</code>ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬å¦‚ä¸‹æ–‡ä»¶</li>
</ul>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>-fill50k\
---conditioning_image\
---iamges\
---fill50k.py
---train.jsonl
</code></pre><ul>
<li>
<p>ç”±äºæ•°æ®ä¸‹è½½åœ¨æœ¬åœ°ï¼Œå¯¹ <code>fill50k.py</code> è¿›è¡Œä¿®æ”¹ç»™å®šæ•°æ®å­˜å‚¨è·¯å¾„:<br>
<img src="./README_files/fill50kpy.png" width="800" height="80"></p>
</li>
<li>
<p>åŠ è½½æ•°æ®é›†æ—¶ä½¿ç”¨ <code>dataset</code> ä¸­çš„ <code>load_dataset</code> æ–¹æ³•åŠ è½½</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-from">from</span> datasets <span class="token keyword keyword-import">import</span> load_dataset

dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span>train_data_dir<span class="token punctuation">)</span>
</code></pre><h4 id="æ¨¡å‹è®­ç»ƒ">æ¨¡å‹è®­ç»ƒ </h4>
<ul>
<li>å¯¹è®­ç»ƒä»£ç æ— éœ€è¿›è¡Œä¿®æ”¹ï¼Œåªéœ€è¦åœ¨è„šæœ¬æ–‡ä»¶ <code>controlnet.sh</code> æ–‡ä»¶ä¸­ä¿®æ”¹æ•°æ®é›†è·¯å¾„ <code>train_data_dir</code> ä¸ºå¯¹åº” <code>py</code> æ–‡ä»¶ä½ç½®ï¼Œè„šæœ¬æ–‡ä»¶ä½ç½® <code>/train21/intellQA/permanent/kunhu10/diffusers-main/controlnet.sh</code><br>
<img src="./README_files/run_sh.png" width="800" height="220"></li>
</ul>
<p>ğŸ¤—<strong>è®­ç»ƒä»£ç è§£é‡Š: train_controlnet_sdxl.py</strong></p>
<ul>
<li>line 66-164: <code>def log_validation()</code><br>
è‹¥åœ¨è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ éªŒè¯promptä»¥åŠconditioning_imagesï¼Œåˆ™åœ¨è¾¾åˆ°éªŒè¯ step æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ¨ç†å‡ºå›¾éªŒè¯ç»“æœï¼Œå¹¶åŠ è½½åˆ° log ä¸­</li>
<li>line 166-184: <code>def import_model_class_from_model_name_or_path()</code><br>
ç»™å®šä¸‹è½½çš„æ¨¡å‹æƒé‡è·¯å¾„ï¼ŒåŠ è½½æ¨¡å‹</li>
<li>line 224-591: <code>def parse_args()</code><br>
å®šä¹‰å‘½ä»¤è¡Œå‚æ•°ï¼Œé™¤äº†è®­ç»ƒçš„é»˜è®¤è¶…å‚æ•°å¤–ï¼Œéœ€è¦æ³¨æ„ç»™å®šäº†åŠ è½½æ•°æ®é›†æ—¶é»˜è®¤çš„åˆ—åç§°<br>
<img src="./README_files/args.png" width="600" height="200"><br>
è¿™ä¸ <code>train.jsonl</code> ä¸­å„ä¸ªæ•°æ®é”®å€¼å¯¹çš„åç§°å¯¹åº”</li>
<li>line: 593-668: <code>def get_train_dataset()</code><br>
ä½¿ç”¨ <code>load_dataset</code> æ–¹æ³•ä»¥åŠ <code>image_column</code> <code>text_column</code> <code>conditioning_column</code> åŠ è½½æ•°æ®ï¼Œè¿”å›åˆå§‹æ•°æ®é›†<br>
<img src="./README_files/get_dataset.png" width="600" height="260"></li>
<li>line 671-709: <code>def encode_prompt(prompt_batch,text_encoders)</code><br>
æ­¤å‡½æ•°æ—¨åœ¨å°†æ–‡æœ¬è¾“å…¥è½¬æ¢ä¸º embeddingï¼Œç»™å®š batch å†…çš„ prompt æ–‡æœ¬ï¼Œ ä½¿ç”¨ <code>text_encoder</code> è½¬æ¢ä¸ºæ–‡æœ¬ç‰¹å¾</li>
<li>line 711-745: <code>def prepare_train_dataset()</code><br>
å¯¹æ•°æ®é›†è¿›ä¸€æ­¥å¤„ç†ï¼ŒåŒ…æ‹¬å¯¹ image æ•°æ®å½’ä¸€åŒ–ä»¥åŠè½¬æ¢ä¸º tensor<br>
<img src="./README_files/prepare_dataset.png" width="600" height="250"></li>
<li>line 747-765: <code>def collate_fn()</code><br>
åŠ è½½ dataloader çš„æ–¹æ³•ï¼Œç»™å‡ºäº† batch ä¸­å­˜åœ¨ <code>pixel_values, conditioning_pixel_values, prompt_ids, unet_added_conditions</code></li>
<li>line 767-1246: <code>main()</code> å‡½æ•°</li>
<li>line 807-887: é€šè¿‡ä¸‹è½½çš„æ¨¡å‹æƒé‡åŠ è½½æ¨¡å‹å¦‚ <code>text_encoder</code>,<code>noise_scheduler</code>,<code>vae</code>,<code>unet</code>,<code>controlnet</code>, å¹¶æŒ‡å®šåªè®­ç»ƒ <code>controlnet</code> éƒ¨åˆ†çš„å‚æ•°<pre data-role="codeBlock" data-info="py" class="language-python py"><code>vae<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
unet<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
text_encoder_one<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
text_encoder_two<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
controlnet<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
<li>line 971-993: å®šä¹‰äº† <code>compute_embeddings()</code> å‡½æ•°ï¼Œä½¿ç”¨ <code>encode_prompt()</code> å‡½æ•°å¯¹æ–‡æœ¬éƒ¨åˆ†è®¡ç®— embeddings å¹¶åŠ è½½è¿›æ•°æ®é›†<br>
<img src="./README_files/compute_embeddings.png" width="600" height="320"></li>
<li>line 996-1026: æ„å»ºæ•°æ®é›†ä»¥åŠç”¨äºè®­ç»ƒçš„ dataloader<br>
<img src="./README_files/train_dataloader.png" width="600" height="460"></li>
<li>line 1068-1116: prepare to trainï¼Œprintè®­ç»ƒå‚æ•°, è®­ç»ƒè¿›ç¨‹bar</li>
<li>line 1117-1223: åŠ è½½ batch å†…æ•°æ®å¼€å§‹è®­ç»ƒï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª stepï¼Œå¹¶é¢„æµ‹è¯¥æ­¥çš„å™ªå£°ï¼Œä½¿ç”¨mseæŸå¤±å‡½æ•°ï¼Œä»¥åŠåå‘ä¼ æ’­è¿‡ç¨‹<br>
<img src="./README_files/start_train.png" width="600" height="440"></li>
</ul>
<h2 id="2-é˜¶æ®µ2">2. é˜¶æ®µ2 </h2>
<h3 id="-å®éªŒä¸€å…¨é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ">ğŸ˜€ å®éªŒä¸€ï¼šå…¨é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ </h3>
<h4 id="æ•°æ®é›†å‡†å¤‡-1">ğŸ“•æ•°æ®é›†å‡†å¤‡ </h4>
<ul>
<li>
<p>é€‰å–26é”®æ•´ä¸ªæ•´ç›˜çš„çš®è‚¤ï¼Œç»Ÿä¸€ reshape ä¸º 512Ã—512 åˆ†è¾¨ç‡å¤§å°ï¼Œå¹¶æè¾¹å‡ºconditioning_image å¦‚ä¸‹<br>
<img src="./README_files/wholekeyboard.png" width="300" height="300"> &nbsp;&nbsp;<img src="./README_files/wholekeyboard_c.png" width="300" height="300"></p>
</li>
<li>
<p>æè¾¹æ–¹æ³•ä½¿ç”¨è½®å»“æ£€æµ‹æ–¹æ³•ï¼Œ<code>cv2.Canny</code>ï¼Œæ§åˆ¶å›¾ç‰‡ä¹Ÿè¦è°ƒæ•´ä¸ºåŒæ ·å¤§å°åˆ†è¾¨ç‡ï¼Œæ‰€æœ‰ç›®æ ‡å›¾ç‰‡éƒ½ä½¿ç”¨äº†åŒä¸€å¼ æ§åˆ¶å›¾ç‰‡</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-import">import</span> cv2
<span class="token keyword keyword-from">from</span> PIL <span class="token keyword keyword-import">import</span> Image
image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"./.."</span><span class="token punctuation">)</span>
low_threshold <span class="token operator">=</span> <span class="token number">50</span>
high_threshold <span class="token operator">=</span> <span class="token number">80</span>
canny_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>image<span class="token punctuation">,</span>low_threshold<span class="token punctuation">,</span>high_threshold<span class="token punctuation">)</span>
</code></pre><ul>
<li>
<p>æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_50/</code>,åŒ…å«å¦‚ä¸‹æ–‡ä»¶<br>
<img src="./README_files/keyboard50.png" width="290" height="150"></p>
</li>
<li>
<p>å…¶ä¸­ <code>keyboard_50.py</code> ä¸­åŒæ ·ä¿®æ”¹äº†<code>metadata_path</code>ï¼Œ<code>images_dir</code> ä»¥åŠ <code>conditioning_images_dir</code></p>
</li>
<li>
<p>å¯¹äºå›¾ç‰‡çš„æ–‡æœ¬æ ‡ç­¾ï¼Œä½¿ç”¨ Blip æ¨¡å‹è¿›è¡Œæ³¨é‡Šï¼Œå°†æ–‡æœ¬æ³¨é‡Šä¿å­˜åœ¨ <code>train.jsonl</code> ä¸­ï¼Œå®ç°</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-from">from</span> PIL <span class="token keyword keyword-import">import</span> Image
<span class="token keyword keyword-from">from</span> transformers <span class="token keyword keyword-import">import</span> BlipProcessor<span class="token punctuation">,</span> BlipForConditionalGeneration
<span class="token keyword keyword-import">import</span> os
processor <span class="token operator">=</span> BlipProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"/train21/intell0A/permanent/kunhu10/diffusers-main/base_models/blip-image-captioning-large"</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> BlipForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>"<span class="token operator">/</span>train21<span class="token operator">/</span>intellQA<span class="token operator">/</span>permanent<span class="token operator">/</span>kunhu10<span class="token operator">/</span>diffusers<span class="token operator">-</span>main<span class="token operator">/</span> \\
base_models<span class="token operator">/</span>blip<span class="token operator">-</span>image<span class="token operator">-</span>captioning<span class="token operator">-</span>large<span class="token string">").to("</span>cuda<span class="token punctuation">:</span><span class="token number">0</span>"<span class="token punctuation">)</span>

dataset_path <span class="token operator">=</span> <span class="token string">'./dataset/controlnet/keyboard_102/images/'</span>
image_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
text_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>dataset_path <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.png'</span></span><span class="token punctuation">)</span>
    image_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>raw_image<span class="token punctuation">)</span>
    text_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"a keyboard skin of"</span><span class="token punctuation">)</span>
inputs <span class="token operator">=</span> processor<span class="token punctuation">(</span>image_list<span class="token punctuation">,</span> text_list<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">"pt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda:2"</span><span class="token punctuation">)</span>
out <span class="token operator">=</span> model<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span>
<span class="token keyword keyword-import">import</span> json
<span class="token comment"># ç”Ÿæˆjsonlæ–‡ä»¶</span>
output_json_path <span class="token operator">=</span> <span class="token string">'./dataset/controlnet/keyboard_102/train.jsonl'</span>
new_jsonl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># éå†æ¯ä¸€å¼ å›¾ç‰‡çš„"image"</span>
<span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"text"</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> skip_special_tokens<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">",iflyskin"</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"images/</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">,</span>\\
    <span class="token string">"conditioning_image"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"conditioning_images/</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">}</span>
    new_jsonl<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image_info<span class="token punctuation">)</span>
<span class="token comment"># å°†jsonlæ•°æ®å†™å…¥åˆ°jsonlæ–‡ä»¶ä¸­</span>
<span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> json_file<span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> image_info <span class="token keyword keyword-in">in</span> new_jsonl<span class="token punctuation">:</span>
        json_line <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>image_info<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        json_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json_line <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
</code></pre><p>å…·ä½“å¯å‚è€ƒ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/caption.py</code> æ–‡ä»¶</p>
<h4 id="æ¨¡å‹è®­ç»ƒ-1">æ¨¡å‹è®­ç»ƒ </h4>
<ul>
<li>æ›´æ”¹ <code>controlnet.sh</code> ä¸­çš„æ•°æ®é›†è·¯å¾„ <code>train_data_dir</code> å³å¯è®­ç»ƒï¼Œè®­ç»ƒä»£ç ä¸åšä¿®æ”¹</li>
</ul>
<h4 id="å®éªŒç»“æœ">å®éªŒç»“æœ </h4>
<ul>
<li><code>diffusers-main</code> ä¸­å°è£…å¥½äº†ç”¨äºæ¨ç†æ­¥éª¤çš„ pipeline ç”¨äºç”Ÿæˆå›¾ç‰‡ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</li>
</ul>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-from">from</span> diffusers <span class="token keyword keyword-import">import</span> StableDiffusionXLControlNetPipeline<span class="token punctuation">,</span> ControlNetModel<span class="token punctuation">,</span> UniPCMultistepScheduler
<span class="token keyword keyword-from">from</span> diffusers<span class="token punctuation">.</span>utils <span class="token keyword keyword-import">import</span> load_image
<span class="token keyword keyword-import">import</span> torch

base_model_path <span class="token operator">=</span> "<span class="token operator">/</span>train21<span class="token operator">/</span>intellQA<span class="token operator">/</span>permanent<span class="token operator">/</span>kunhu10<span class="token operator">/</span>diffusers<span class="token operator">-</span>main<span class="token operator">/</span>base_models<span class="token operator">/</span>stable<span class="token operator">-</span>diffusion<span class="token operator">-</span>xl<span class="token operator">-</span>base<span class="token operator">-</span><span class="token number">1.0</span>
controlnet_path <span class="token operator">=</span> <span class="token string">"/train21/intellQA/permanent/kunhu10/diffusers-main/saved_models/controlnet_sdxl/test_version_24/checkpoint-16000/controlnet"</span>  <span class="token comment"># å¾…æµ‹è¯•çš„controlnetä¿å­˜ä½ç½®</span>
controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>controlnet_path<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span> <span class="token comment">#åŠ è½½controlnet</span>
pipe <span class="token operator">=</span> StableDiffusionXLControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    base_model_path<span class="token punctuation">,</span> controlnet<span class="token operator">=</span>controlnet<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16
<span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
<span class="token comment"># speed up diffusion process with faster scheduler and memory optimization</span>
pipe<span class="token punctuation">.</span>scheduler <span class="token operator">=</span> UniPCMultistepScheduler<span class="token punctuation">.</span>from_config<span class="token punctuation">(</span>pipe<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
<span class="token comment"># remove following line if xformers is not installed or when using Torch 2.0</span>
pipe<span class="token punctuation">.</span>enable_xformers_memory_efficient_attention<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># memory optimization</span>
pipe<span class="token punctuation">.</span>enable_model_cpu_offload<span class="token punctuation">(</span><span class="token punctuation">)</span>
prompt <span class="token operator">=</span> <span class="token string">"a picture of ..."</span>
control_image <span class="token operator">=</span> load_image<span class="token punctuation">(</span><span class="token string">"...."</span><span class="token punctuation">)</span>
generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    prompt<span class="token operator">=</span>prompt<span class="token punctuation">,</span>image<span class="token operator">=</span>control_image<span class="token punctuation">,</span>num_inference_steps<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>generator<span class="token operator">=</span>generator
<span class="token punctuation">)</span><span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre><ul>
<li>
<p>StableDiffusionXLControlNetPipeline è¿˜æ”¯æŒåŒ…æ‹¬tensorç±»å‹çš„text_embedsï¼Œä»¥åŠimage_embeds ç­‰å¤šç§è¾“å…¥ï¼Œè¾“å‡ºç±»å‹ä¹Ÿæœ‰ tensor, numpy_array, image å¤šç§ï¼Œå…·ä½“å¯æŸ¥çœ‹ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/src/diffusers/pipelines/controlnet/pipeline_controlnet_sd_xl.py</code> ä¸­å®šä¹‰çš„ <code>StableDiffusionXLControlnetPipeline</code>ç±»</p>
</li>
<li>
<p>æ‰¹é‡æ¨ç†å›¾ç‰‡ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/inferece.py</code> ä¸­å®ç°</p>
</li>
<li>
<p>åœ¨ä½¿ç”¨ 50 å¼ è¾ƒå¥½å›¾ç‰‡è®­ç»ƒ 3000 step ä»¥åŠ 6000 step çš„ç»“æœå¦‚ä¸‹<br>
<img src="./README_files/wholekeyboard_result.png" width="300" height="300"> &nbsp;&nbsp;<img src="./README_files/wholekeyboard_result2.png" width="300" height="300"></p>
</li>
</ul>
<h3 id="-å®éªŒäºŒåˆ†å—é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ">ğŸ˜€ å®éªŒäºŒï¼šåˆ†å—é”®ç›˜çš®è‚¤æ•°æ®è®­ç»ƒ </h3>
<h4 id="æ•°æ®é›†å‡†å¤‡-2">ğŸ“•æ•°æ®é›†å‡†å¤‡ </h4>
<ul>
<li>é‰´äºå…¨é”®ç›˜çš®è‚¤éš¾ä»¥ä½¿ç”¨ï¼Œæä¾›æ•°æ®ä¸­åŒ…æ‹¬ç›¸å½“ä¸€éƒ¨åˆ†å°†é”®ç›˜çš®è‚¤åˆ‡åˆ†æˆå¦‚ä¸‹å››å—çš„æ–°è§„èŒƒ<br>
<img src="./README_files/4parts_keyboard.png" width="300" height="300"></li>
</ul>
<p>ğŸ¤—<strong>ä½¿ç”¨åŒä¸€ conditioning_image</strong></p>
<ul>
<li>
<p>æ”¶é›†è¯¥ç±»çš®è‚¤æ•°æ®å¹¶ç»Ÿä¸€å¤§å°ï¼Œå…±æ”¶é›† 2000 å¼ ï¼Œä¿å­˜äº <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard2k</code> ä¸­</p>
</li>
<li>
<p>åœ¨ <code>keyboard2k</code> æ•°æ®é›†ä¸‹ï¼Œä½¿ç”¨çš„æ§åˆ¶å›¾ç‰‡éƒ½æ˜¯ä¸‹é¢çš„ <strong>åŒä¸€å¼ </strong>ï¼Œæ—¨åœ¨é€šè¿‡åŒä¸€å¼ æ§åˆ¶å›¾ç‰‡å›å½’åˆ°ä¸åŒçš„çš®è‚¤ï¼Œå¢å¼ºçš®è‚¤ç”Ÿæˆçš„å¤šæ ·æ€§<br>
<img src="./README_files/4parts_keyboard_c.png" width="300" height="300"></p>
</li>
<li>
<p><code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard2k/keyboard2k.py</code> å¯¹æ•°æ®é›†è·¯å¾„å·²ç»è¿›è¡Œäº†ä¿®æ”¹</p>
</li>
<li>
<p>ç”±äº 2k å¼ å›¾ç‰‡ä¸­å¤§éƒ¨åˆ†ä¸åŒéƒ¨åˆ†çš„å›¾å±‚å åŠ ä¸æ­£ç¡®ï¼Œåˆé‡æ–°ç­›é€‰äº†å¯¹åº”å…³ç³»è¾ƒå¥½çš„æ•°æ®ï¼Œå…±102å¼  (åº•å›¾åæ˜ åœ¨é¢„è§ˆå›¾ä¸Šï¼Œä¸”å…·æœ‰é”®ç›˜æ ·å¼)ï¼Œæ•°æ®æ–‡ä»¶ä»¥åŠæ•°æ®é›†æ„å»ºæ–¹æ³•åœ¨  <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_102/</code> ä¸­</p>
</li>
</ul>
<p>ğŸ¤—<strong>conditioning_image æ¸²æŸ“æ–‡å­—</strong></p>
<ul>
<li>
<p>å°è¯•åœ¨æ§åˆ¶å›¾ç‰‡ä¸Šæ¸²æŸ“ä¸Šç›®æ ‡å›¾ç‰‡çš„æ–‡å­—ï¼Œè¾¾åˆ°ç”Ÿæˆçš®è‚¤ä¸­æŒ‰è¦æ±‚å‡ºç°æ–‡å­—çš„ç›®çš„</p>
</li>
<li>
<p>ä½¿ç”¨ paddle OCR æ£€æµ‹å‡ºæ–‡æœ¬æ‰€åœ¨ box ä»¥åŠæ–‡æœ¬ï¼Œå°†å‡†ç¡®åº¦å¤§äº0.98 çš„æ–‡æœ¬æ¸²æŸ“åˆ°ç»Ÿä¸€çš„æè¾¹èƒŒæ™¯ä¸Š</p>
</li>
<li>
<p>å®ç°åœ¨ <code>/train21/intellQA/permanent/kunhu10/GlyphControl/ocr.py</code> ä¸­ï¼Œä¸»ä½“å¦‚ä¸‹ï¼š<br>
<img src="./README_files/render_back.png" width="800" height="380"></p>
<ul>
<li>å…¶ä¸­ background_path å³ç»Ÿä¸€æè¾¹èƒŒæ™¯å›¾ï¼Œè‹¥è¿è¡Œæ—¶ paddleocr æŠ¥é”™ç¼ºå°‘ <code>.so</code> æ–‡ä»¶ç­‰ï¼Œè€ƒè™‘ <code>module load gcc/xxx</code> å’Œ <code>module load cuda/11.7</code></li>
<li>åœ¨ç¦»çº¿çŠ¶æ€ä¸‹ï¼ŒpaddleOCR æ— æ³•ä¸‹è½½æ–‡æœ¬æ£€æµ‹ä»¥åŠè¯†åˆ«æ¨¡å‹æƒé‡ï¼Œéœ€è¦æ‰‹åŠ¨ä¸‹è½½ï¼Œå¹¶æ›´æ”¹ <code>tools/infer/utilify.py</code> ä¸­çš„å‚æ•°ï¼Œå…·ä½“å‚è€ƒ(<a href="https://blog.csdn.net/weixin_47151919/article/details/122066480">https://blog.csdn.net/weixin_47151919/article/details/122066480</a>)<br>
<img src="./README_files/ppocr_param.png" width="700" height="100"></li>
</ul>
</li>
<li>
<p>æ¸²æŸ“æ–‡å­—åçš„æè¾¹å›¾æ„å»ºçš„æ•°æ®é›†ä¿å­˜åœ¨<code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_102/</code> ä¸­</p>
</li>
</ul>
<h4 id="æ¨¡å‹è®­ç»ƒ-2">æ¨¡å‹è®­ç»ƒ </h4>
<ul>
<li>è®­ç»ƒä»£ç ä¸åšä¿®æ”¹ï¼Œè®­ç»ƒè„šæœ¬ä¸­æ³¨æ„æ›´æ”¹åˆ†è¾¨ç‡å‚æ•° <code>--resolution</code></li>
<li>å¦‚æœæ˜¯å¾®è°ƒå®éªŒåªéœ€åœ¨è®­ç»ƒè„šæœ¬å‚æ•°ä¸­åŠ ä¸Š <code>--controlnet_model_name_or_path</code> ï¼Œä¸ºå¾®è°ƒçš„åŸºç¡€æ¨¡å‹è·¯å¾„</li>
<li>æŒ‰ç…§ä¸åŒ conditioning_image ä»¥åŠä¸åŒåˆ†è¾¨ç‡è¿›è¡Œäº†ä¸€ç³»åˆ—å®éªŒ</li>
</ul>
<table>
<thead>
<tr>
<th>å®éªŒç¼–å·</th>
<th>type</th>
<th>dataset-size</th>
<th>conditioning-image</th>
<th>resolution</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ä»å¤´è®­ç»ƒ</td>
<td>2k</td>
<td>æ‰€æœ‰æ•°æ®ä½¿ç”¨åŒä¸€æ§åˆ¶å›¾</td>
<td>512</td>
<td>å¤šæ ·æ€§è¾ƒå¥½ï¼Œå›¾å±‚å åŠ ä¸å¯¹åº”</td>
</tr>
<tr>
<td>2</td>
<td>ä»å¤´è®­ç»ƒ</td>
<td>102</td>
<td>æ‰€æœ‰æ•°æ®ä½¿ç”¨åŒä¸€æ§åˆ¶å›¾</td>
<td>512</td>
<td>å›¾å±‚å åŠ å¯¹åº”ï¼Œè®­ç»ƒåˆ°ç¨³å®šç»“æ„åç†è§£æ–‡æœ¬å·®</td>
</tr>
<tr>
<td>3</td>
<td>å¾®è°ƒ Canny</td>
<td>102</td>
<td>æ‰€æœ‰æ•°æ®ä½¿ç”¨åŒä¸€æ§åˆ¶å›¾</td>
<td>512</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>ä»å¤´è®­ç»ƒ</td>
<td>102</td>
<td>æ¯å¼ æ§åˆ¶å›¾æ¸²æŸ“å¯¹åº”æ–‡å­—</td>
<td>1024</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>å¾®è°ƒ Canny</td>
<td>102</td>
<td>æ¯å¼ æ§åˆ¶å›¾æ¸²æŸ“å¯¹åº”æ–‡å­—</td>
<td>1024</td>
<td>ç»“æ„ç¨³å®šæ–‡æœ¬ç†è§£è¾ƒå¥½ï¼Œå¤šæ ·æ€§ä¸€èˆ¬</td>
</tr>
</tbody>
</table>
<h4 id="å®éªŒç»“æœ-1">å®éªŒç»“æœ </h4>
<ul>
<li>ç¬¦åˆåŸºæœ¬é”®ç›˜è§„èŒƒï¼Œæ¨¡å‹å­¦ä¹ åˆ°ç›¸å…³ç»“æ„å¸ƒå±€ä¿¡æ¯<br>
<img src="./README_files/4parts_results1.png" width="300" height="300"> &nbsp;&nbsp;<img src="./README_files/4parts_results2.png" width="300" height="300"></li>
</ul>
<h2 id="3-é˜¶æ®µ3">3. é˜¶æ®µ3 </h2>
<h3 id="-å®éªŒä¸€å…³é”®é”®ç›˜å…ƒç´ å¸ƒå±€çš®è‚¤">ğŸ˜€ å®éªŒä¸€ï¼šå…³é”®é”®ç›˜å…ƒç´ å¸ƒå±€çš®è‚¤ </h3>
<ul>
<li>ä¸ºäº†è¿›ä¸€æ­¥é€‚åº”ä½¿ç”¨éœ€æ±‚ï¼Œè¦æ±‚çš®è‚¤å¸ƒå±€ä»…éœ€è¦å…³é”®å…ƒç´ å¦‚å¯¼èˆªæ ï¼ŒåŠŸèƒ½é”®ï¼Œ26é”®ï¼Œ9é”®èƒŒæ™¯ç­‰ï¼Œå¦‚ä¸‹å›¾<br>
<img src="./README_files/key_elements_ex.png" width="300" height="300"></li>
</ul>
<h4 id="-æ•°æ®å‡†å¤‡">ğŸ“• æ•°æ®å‡†å¤‡ </h4>
<ul>
<li>ä»çš®è‚¤å•†åŸä»¥åŠç¤¾åŒºçš®è‚¤ä¸­ç­›é€‰äº†éƒ¨åˆ†å¯ç”¨æ•°æ®ï¼Œè¿™äº›çš®è‚¤æ˜¯æŒ‰ç…§åè®®ç»„åˆå„ä¸ªå…ƒç´ å›¾ç‰‡è€Œæˆï¼Œå¯¹äºæ¯ä¸ªé”®ç›˜çš®è‚¤ï¼Œæœ‰å¦‚ä¸‹æ–‡ä»¶å¤¹ï¼ŒåŒ…å«äº†å„ä¸ªé”®çš„å›¾ç‰‡æ–‡ä»¶<br>
<img src="./README_files/key_elements_folder.png" width="400" height="300"></li>
<li>è¿™äº›æ–‡ä»¶å¤¹ç»Ÿä¸€ä¿å­˜åœ¨ <code>/train21/intellQA/permanent/kunhu10/GlyphControl/image_path_folder/</code> ä¸­</li>
<li>å¸ƒå±€è¿™äº›å…ƒç´ åˆ°åŒä¸€å¼ ç”»å¸ƒä¸Šï¼Œåˆ¶å®šäº†ä¸€å®šçš„è§„åˆ™ (å„ä¸ªåŠŸèƒ½é”®çš„åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®)ï¼Œä¸»è¦å®ç°åœ¨ <code>load_image</code> å‡½æ•°ä¸­ï¼Œå®šä¹‰äº†æ¯ä¸ªæŒ‰é”®å…ƒç´ çš„å¤§å°ä»¥åŠä½ç½®</li>
<li>å®ç°æ–¹å¼åœ¨ <code>/train21/intellQA/permanent/kunhu10/GlyphControl/merge_image.py</code> ä¸­<br>
<img src="./README_files/merge_images.png" width="600" height="450"></li>
<li>ç»è¿‡ä¸¤æ¬¡æå–ï¼Œä¸€å…±å¾—åˆ° 332 å¼ å¯ç”¨çš®è‚¤ï¼Œconditioning_images ä»¥åŠæ–‡æœ¬æ ‡ç­¾ç­‰æŒ‰ç…§ä¹‹å‰æ–¹æ³•åˆ›å»ºï¼Œä¿å­˜åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_332_512/</code> ä»¥åŠ  <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_332_1024/</code> ä¸­ï¼ŒäºŒè€…åˆ†è¾¨ç‡ä¸åŒ<br>
<img src="./README_files/key_elements_demo.png" width="300" height="300"></li>
</ul>
<h4 id="æ¨¡å‹è®­ç»ƒ-3">æ¨¡å‹è®­ç»ƒ </h4>
<ul>
<li>è®­ç»ƒæ–¹å¼ä¸ä¹‹å‰ç›¸åŒï¼Œå½“è®­ç»ƒ 1024Ã—1024 çš„å›¾åƒæ—¶ï¼Œéœ€ä½¿ç”¨ 80GB æ˜¾å¡</li>
<li>å¤šå¡å¹¶è¡Œè®­ç»ƒæ˜¯é€šè¿‡ accelerate å®ç°çš„ï¼Œè®¾ç½®å‚æ•°æ—¶ï¼Œåœ¨å‘½ä»¤è¡Œ <code>accelerate config</code> è¿›è¡Œé€‰æ‹©æˆ–è€…åœ¨<code>home</code>ç›®å½•ä¸‹æ›´æ”¹ <code>.cache/huggingface/accelarate/defaut_config.yaml</code> æ–‡ä»¶ï¼Œå¦‚ä¿®æ”¹ä¸º8å¡å¹¶è¡Œçš„é…ç½®å¦‚ä¸‹<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>compute_environment: LOCAL_MACHINE
  distributed_type: MULTI_GPU
  downcast_bf16: <span class="token string">'no'</span>
  gpu_ids: all
  machine_rank: <span class="token number">0</span>
  main_training_function: main
  mixed_precision: <span class="token string">'no'</span>
  num_machines: <span class="token number">1</span>
  num_processes: <span class="token number">8</span>
  rdzv_backend: static
  same_network: <span class="token boolean">false</span>
  tpu_env: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  tpu_use_cluster: <span class="token boolean">false</span>
  tpu_use_sudo: <span class="token boolean">false</span>
  use_cpu: <span class="token boolean">false</span>
</code></pre></li>
</ul>
<h4 id="å®éªŒç»“æœ-2">å®éªŒç»“æœ </h4>
<ul>
<li>ä¸é¢„æœŸç¬¦åˆï¼Œå¸ƒå±€è§„èŒƒï¼Œä½†æ˜¯å›¾ç‰‡ä¸­æ–‡æœ¬éƒ¨åˆ†ä»ç„¶å­˜åœ¨é—®é¢˜<br>
<img src="./README_files/key_elements_results1.png" width="300" height="300"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="./README_files/key_elements_results2.png" width="300" height="300"></li>
</ul>
<h3 id="-å®éªŒäºŒæ·»åŠ ctc-lossç›‘ç£å›¾ç‰‡ä¸­çš„æ–‡æœ¬ç”Ÿæˆ">ğŸ˜€ å®éªŒäºŒï¼šæ·»åŠ ctc-lossç›‘ç£å›¾ç‰‡ä¸­çš„æ–‡æœ¬ç”Ÿæˆ </h3>
<h4 id="-æ•°æ®å‡†å¤‡-1">ğŸ“• æ•°æ®å‡†å¤‡ </h4>
<ul>
<li>
<p>ç›‘ç£æ˜¯å¦ç”Ÿæˆå¯è¯†åˆ«æ–‡æœ¬ï¼Œæ•°æ®ä¸­éœ€åŒ…å«æ­£ç¡®æ–‡æœ¬çš„æ ‡ç­¾ä»¥åŠå›¾ç‰‡ä¸­æ–‡æœ¬æ‰€åœ¨åŒºåŸŸä¿¡æ¯</p>
</li>
<li>
<p>åœ¨ <code>train.jsonl</code> æ–‡ä»¶ä¸­è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ­¤æ—¶æ¯ä¸€è¡Œä¸ºå¦‚ä¸‹é”®å€¼å¯¹ï¼Œä¿å­˜åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_332_512/</code></p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>{"text":"a picture of a girl with long hair, iflyskin, writing \"å‰å¾€ \","image":"images/0.png",
"conditioning_image":"conditioning_images/0.png",
"box":[[[430.0,174.0],[450.0,174.0],[450.0,186.0],[430.0,186.0]]]}
</code></pre></li>
<li>
<p>å¯¹æ•°æ®é›†åŠ è½½æ–¹æ³• (<code>/train21/intellQA/permanent/kunhu10/diffusers-main/dataset/controlnet/keyboard_332_512/keyboard_332_512.py</code>) è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ æ–°çš„æ•°æ®æ ¼å¼å¤šç»´æ•°ç»„<br>
<img src="./README_files/keyboard_box.png" width="400" height="130"></p>
</li>
<li>
<p>å¯¹äºæ•°æ®é›†å‡†å¤‡ä»¥åŠåŠ è½½dataloaderçš„éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œä¿å­˜äº <code>/train21/intellQA/permanent/kunhu10/diffusers-main/train_controlnet_sdxl_own.py</code> ä¸­</p>
</li>
<li>
<p>ä¿®æ”¹ <code>prepare_train_dataset</code> å‡½æ•°ä¸­ <code>process_train</code> å¦‚ä¸‹ï¼š<br>
<img src="./README_files/process_train.png" width="700" height="430"></p>
</li>
<li>
<p>ä¿®æ”¹ <code>collate_fn</code> å‡½æ•°å¦‚ä¸‹ï¼š<br>
<img src="./README_files/collate_fn.png" width="700" height="330"><br>
å…¶ä¸­ <code>gt_text,text_length,box</code> æ˜¯æ¯æ¡æ•°æ®æ–°å¢çš„è¾“å…¥ç±»å‹ï¼Œåˆ†åˆ«è¡¨ç¤ºground-truthçš„æ–‡æœ¬æ ‡ç­¾ï¼Œæ–‡æœ¬é•¿åº¦ä»¥åŠæ–‡æœ¬æ¡†ä½ç½®ï¼Œç”¨äºç›‘ç£æ–‡æœ¬ç”Ÿæˆ</p>
</li>
</ul>
<h4 id="æ¨¡å‹è®­ç»ƒ-4">æ¨¡å‹è®­ç»ƒ </h4>
<p>ğŸ¤—<code>train_controlnet_sdxl_own.py</code> <strong>ä¿®æ”¹</strong></p>
<ul>
<li>
<p>æ·»åŠ ç”¨äºppocrè¯†åˆ«çš„å­—å…¸ï¼Œå³ä½¿ç”¨ä¸€ä¸ªä¿å­˜äº†å¸¸è§æ±‰å­—ç¬¦çš„æ–‡æœ¬æ–‡ä»¶åˆ›å»ºdict<br>
<img src="./README_files/dict.png" width="600" height="100"></p>
</li>
<li>
<p>åˆå§‹åŒ–äº†ç”¨äºæ–‡æœ¬è¯†åˆ«çš„ppocræ¨¡å‹ï¼Œå…¶ç›¸å…³å®ç°ä»¥åŠæ¨¡å‹æƒé‡ä¿å­˜åœ¨ <code>/train21/intellQA/permanent/kunhu10/diffusers-main/Anytext/</code> ä¸­, <code>text_recognizer</code> ç”¨äºåç»­åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¯¹ç›‘ç£æ¨ç†å›¾ç‰‡ä¸­çš„æ–‡æœ¬éƒ¨åˆ†<br>
<img src="./README_files/text_recognize.png" width="650" height="100"></p>
</li>
<li>
<p>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¾¹è®­ç»ƒè¾¹æ¨ç†å½“å‰æ¨¡å‹çš„å‡ºå›¾ç»“æœï¼Œä½¿ç”¨ <code>infer_img</code> å‡½æ•°å®ç°æ¨ç†è¿‡ç¨‹<br>
<img src="./README_files/infer_img.png" width="650" height="500"><br>
ç»™å®šå½“å‰ <code>batch</code> ä»¥åŠ <code>vae</code>,<code>unet</code> (å†»ç»“) ä»¥åŠ <code>controlnet</code> (è®­ç»ƒ) æ¨¡å‹ï¼Œå³å¯å¾—åˆ°è¾“å‡º images tensor</p>
</li>
<li>
<p>è®¡ç®— ctc_loss çš„å®ç°åœ¨<code>/train21/intellQA/permanent/kunhu10/diffusers-main/Anytext/recognizer.py</code> ä¸­ã€‚æœ¬å®éªŒä¸­ä½¿ç”¨ <code>OCR_ctcloss</code> å‡½æ•°æ¥æ”¶é¢„æµ‹å›¾ç‰‡ä»¥åŠæ ‡ç­¾è®¡ç®—æŸå¤±<br>
<img src="./README_files/loss_ctc.png" width="750" height="250"></p>
</li>
<li>
<p>ä¸€æ¬¡forward è®¡ç®— <code>loss_ctc</code> çš„è¿‡ç¨‹å¦‚ä¸‹</p>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-for">for</span> epoch <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>first_epoch<span class="token punctuation">,</span>args<span class="token punctuation">.</span>num_train_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword keyword-for">for</span> step<span class="token punctuation">,</span>batch <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
          infer_images <span class="token operator">=</span> infer_img<span class="token punctuation">(</span>args<span class="token punctuation">,</span>accelerator<span class="token punctuation">,</span>noise_scheduler<span class="token punctuation">,</span>vae<span class="token punctuation">,</span>unet<span class="token punctuation">,</span>controlnet<span class="token punctuation">,</span>weight_dtype<span class="token punctuation">,</span>batch<span class="token punctuation">)</span>
          preds<span class="token punctuation">,</span>loss_text <span class="token operator">=</span> OCR_ctcloss<span class="token punctuation">(</span>infer_images<span class="token punctuation">,</span>text_recognizer<span class="token punctuation">,</span>bacth<span class="token punctuation">)</span>
          loss_text <span class="token operator">=</span> loss_text<span class="token punctuation">.</span>to<span class="token punctuation">(</span>accelerator<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>æ¨¡å‹è®­ç»ƒè„šæœ¬æ–‡ä»¶ä¿å­˜ä¸º <code>/train21/intellQA/permanent/kunhu10/diffusers-main/controlnet_own.sh</code></p>
</li>
</ul>
<h4 id="å®éªŒç»“æœ-3">å®éªŒç»“æœ </h4>
<ul>
<li>loss_text éš¾ä»¥ä¸‹é™</li>
</ul>
<h2 id="4-åç»­">4. åç»­ </h2>
<ul>
<li>å¢åŠ æ•°æ®é›†å¤§å°ä»å¤´è®­ç»ƒï¼Œæ•°ç™¾ä¸ªæ•°æ®ç›¸å¯¹è¾ƒå°‘</li>
<li>æ–‡æœ¬æŸå¤±éš¾ä»¥ä¼˜åŒ–ï¼Œå…³æ³¨åç»­ <a href="https://github.com/tyxsspa/AnyText">Anytext</a> å¼€æºåï¼Œå‚è€ƒå®ç°æ–¹å¼</li>
<li>SD3 ä½¿ç”¨ transformer æ›¿ä»£ Unet backbone, å¯¹æ–‡æœ¬ç”Ÿæˆå‹å¥½ï¼Œå…³æ³¨åç»­å®ç°å·¥ä½œ</li>
</ul>

      </div>
      
      
    
    
    
    
    
    
  </body></html>